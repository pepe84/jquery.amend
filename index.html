<!DOCTYPE html>
<html>
  <head>
    <title>jquery.amend demo</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" type="text/css" href="/src/jquery.amend.css">
    <style>
        body {
            position: relative;
            width: 900px;
            margin: 20px auto;
        }
        body, input, textarea {
            font-family: Arial;
            font-size: 1.0em;
        }
        .container {
            overflow: hidden;
            zoom: 1;
        }
        .law,
        #law-index {
            background: #f0f0f0;
            padding: 10px;
        }
        .law {
            float: left;
            width: 650px;
        }
        .column {
            float: right;
            width: 220px;
        }
        #explanation {
            position: fixed;
            width: 220px;
        }
        #law-index {
            font-size: 0.65em;
            font-weight: normal;
        }
            #law-index h1,
            #law-index h2,
            #law-index h3 {
                margin: 0 0 4px 0;
            }
            #law-index h2 {
                padding-left: 10px;
            }
            #law-index h3 {
                padding-left: 20px;
            }
        .add-new-text {
            float: right;
            font-size: 0.7em;
        }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="law">
        <h1 id="preamble" data-reference="t0">Preamble</h1>
        <p data-reference="0.1" class="text">Praesent aliquet commodo mauris non porta. In sit amet tincidunt massa. Maecenas id arcu eget leo consequat molestie. Mauris et sapien fringilla, pretium justo non, aliquet nunc. Suspendisse feugiat congue ipsum, nec elementum massa condimentum eu. In hendrerit molestie facilisis. Morbi pretium ullamcorper tortor sit amet cursus.</p>
        <h1 id="title1" data-reference="t1">Title I. Rights, freedoms and duties</h1>
        <h2 id="title1-section1" data-reference="t1.s1">Section 1. Rights and freedom</h2>
        <h3 id="art1" data-reference="1">Article 1</h2>
        <p data-reference="1.1" class="text">Donec sem massa, consectetur sit amet tempor sed, hendrerit eget tortor. Mauris dolor neque, suscipit cursus tristique ac, feugiat id urna. Nullam pharetra lorem sit amet volutpat aliquet. Cras ac ultricies ipsum. Donec id odio nec justo dapibus pulvinar. Cras nulla tellus, vulputate sed lacus vel, cursus facilisis leo.</p>
        <p data-reference="1.2" class="text">Donec sem massa, consectetur sit amet tempor sed, hendrerit eget tortor. Mauris dolor neque, suscipit cursus tristique ac, feugiat id urna. Nullam pharetra lorem sit amet volutpat aliquet. Cras ac ultricies ipsum. Donec id odio nec justo dapibus pulvinar. Cras nulla tellus, vulputate sed lacus vel, cursus facilisis leo.</p>
        <h3 id="art2" data-reference="2">Article 2</h2>
        <p data-reference="2.1" class="text">Nulla aliquet magna quis pharetra placerat. Pellentesque malesuada elit vitae felis consectetur accumsan. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Suspendisse potenti. In sed posuere sem, sit amet iaculis ipsum.</p>
        <h2 id="title1-section2" data-reference="t1.s2">Section 2. Responsabilities</h2>
        <h3 id="art3" data-reference="3">Article 3</h2>
        <p data-reference="3.1" class="text">In hac habitasse platea dictumst. Mauris felis lacus, adipiscing et quam in, feugiat tincidunt nulla. Nam vel libero nibh. Suspendisse sollicitudin urna non convallis aliquet.</p>
        <h1 id="title2" data-reference="t2">Title II. Economy</h1>
        <h3 id="art4" data-reference="4">Article 4</h3>
        <p data-reference="4.1" class="text">Nulla aliquet magna quis pharetra placerat. Pellentesque malesuada elit vitae felis consectetur accumsan. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Suspendisse potenti. In sed posuere sem, sit amet iaculis ipsum.</p>
        <p data-reference="4.2" class="text">Nulla aliquet magna quis pharetra placerat. Pellentesque malesuada elit vitae felis consectetur accumsan. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Suspendisse potenti. In sed posuere sem, sit amet iaculis ipsum.</p>
        <h3 id="art5" data-reference="5">Article 5</h2>
        <p data-reference="5.1" class="text">Donec sem massa, consectetur sit amet tempor sed, hendrerit eget tortor. Mauris dolor neque, suscipit cursus tristique ac, feugiat id urna. Nullam pharetra lorem sit amet volutpat aliquet. Cras ac ultricies ipsum. Donec id odio nec justo dapibus pulvinar. Cras nulla tellus, vulputate sed lacus vel, cursus facilisis leo.</p>
        <h3 id="art6" data-reference="6">Article 6</h2>
        <p data-reference="6.1" class="text">Nulla aliquet magna quis pharetra placerat. Pellentesque malesuada elit vitae felis consectetur accumsan. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Suspendisse potenti. In sed posuere sem, sit amet iaculis ipsum.</p>
        <p data-reference="6.2" class="text">Nulla aliquet magna quis pharetra placerat. Pellentesque malesuada elit vitae felis consectetur accumsan. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Suspendisse potenti. In sed posuere sem, sit amet iaculis ipsum.</p>
      </div>
      <div class="column">
        <div id="explanation">
          <h1>How it works?</h1>
          <p>Click on any law point or paragraph. A box where you can modify the text that you see or remove it completely will appear.</p>
          <p>You can also enter a new item, article or chapter by clicking on the button at the beginning of each section.</p>
          <div id="law-index"></div>
        </div>
      </div>
    </div>
    <script src="http://code.jquery.com/jquery-git2.js"></script>
    <script src="https://neil.fraser.name/software/diff_match_patch/svn/trunk/javascript/diff_match_patch.js"></script>
    <script src="/src/jquery.amend.js"></script>
    <script type="text/javascript">        
    // Show index
    $('#law-index').append(
      $('.law :header[id]')
        .clone()
        .each(function() {
          $(this).html(
            '<a href="#' + this.id + '">' + this.innerHTML + '</a>'
          )
          .removeAttr('id');
        })
    );
    
    // Initalize listener
    var $fake = $('<div>', {
        'id': 'fake'
    }).on('jqa-confirm', function(event, data, callback) {
        alert('Success creating amendment at ' + data['reference']);
        callback(true);
    }).hide();
    
    $('body').after($fake);
    
    $('.law *').each(function(){        
        
        var elem = this,
            listeners = [
                $fake
            ];
        
        // Add new text event        
        if ($(this).is(':header[id]')) {
            // Build link
            var original = this.innerHTML,
                $addLink = $('<a>', {
                    'href': '#',
                    'class': 'add-new-text closed',
                    'html': '+'
                }).click(function(event){
                    if ($(this).is('.closed')) {
                        $(this).toggleClass('opened').toggleClass('closed');
                        $(elem).trigger('jqa-new');
                    }
                    // Avoid follow            
                    event.preventDefault();
                    return false;
                }).on('jqa-cancel jqa-confirm', function(){
                    $(this).toggleClass('opened').toggleClass('closed');
                });
                listeners.push($addLink);
            // Change headig structure
            $(this)
                .empty()
                .append($('<span>', {
                    'class': 'jqa-text',
                    'html': original
                }))
                .append($addLink);
        } else {
            $(this).addClass('jqa-text');
        }
        
        // Expand/collapse amendments link
        var $showLink = $('<a>', {
            'href': '#',
            'class': 'show-amendments closed',
            'html': '0 amendments'
        }).click(function(event){
            $(this).toggleClass('opened').toggleClass('closed');
            $(elem).trigger('jqa-toggle');
            // Avoid follow            
            event.preventDefault();
            return false;
        }).on('jqa-counter', function(event, count){
            $(this).html(count + ' amendment' + (count === 1 ? '' : 's'));
        });
        listeners.push($showLink);
        
        // Initalize amendments plugin
        $(elem).amend({
            listeners: listeners
        }, [
            {
              "id":"1", 
              "reference": "1.1",
              "amendment": "Donec sem massa, consectetur sit amet tempor sed, hendrerit eget tortor. Mauris dolor neque, suscipit cursus tristique ac, feugiat id urna. Nullam pharetra lorem sit amet volutpat aliquet. Donec id odio nec justo dapibus pulvinar. Cras nulla tellus et nutella, vulputate sed lacus vel, cursus facilisis leo.",
              "reason": "This is real. Or not?",
              "author": "pepe",
              "status": "pending"
            },
            {
              "id":"2", 
              "reference": "1.2",
              "amendment": "Donec sem massa, consectetur sit amet tempor sed, hendrerit eget tortor. Mauris dolor neque, cursus tristique ac ipsum, feugiat id urna. Nullam pharetra lorem sit amet volutpat aliquet. Cras ac ultricies. Donec id odio nec justo dapibus pulvinar. Cras nulla tellus, vulputate sed lacus vel, cursus facilisis leo.",
              "reason": "I have a feeling...",
              "author": "laura",
              "status": "approved"
            },        {
              "id":"3", 
              "reference": "3.1",
              "amendment": "In hac habitasse platea dictumst. Oh! Mauris felis lacus, adipiscing et quam in, feugiat tincidunt nulla. Nam testing amendment. Suspendisse sollicitudin urna non convallis aliquet. ",
              "reason": "Not in my name.",
              "author": "mike",
              "status": "rejected"
            },
            {
              "id":"4", 
              "reference": "t1",
              "amendment": "Section 3. Environment",
              "reason": "I miss a chapter for environment policies. Please, work on a proposal.",
              "author": "jackie",
              "status": "approved",
              "extra": true
            },
            {
              "id":"5", 
              "reference": "6",
              "amendment": "Aliquam porttitor sodales mattis. Vestibulum eros augue, fringilla in quam pulvinar, pulvinar semper elit. Nullam venenatis eros vehicula leo mollis mollis. Suspendisse sit amet turpis sit amet orci semper congue eget at lectus. ",
              "reason": "We need to be more specific.",
              "author": "jackie",
              "status": "approved",
              "extra": true
            }
        ]);
        
        // Render after amend plugin execution (due to DOM changes)
        $(elem).after($showLink);
    });
    </script>
  </body>
</html>
